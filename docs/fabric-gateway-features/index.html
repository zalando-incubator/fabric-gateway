



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.0">
    
    
      
        <title>Features - Fabric Gateway</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.0284f74d.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="https://unpkg.com/mermaid@7.1.2/dist/mermaid.css">
    
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#fabric-gateway" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Fabric Gateway" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Fabric Gateway
            </span>
            <span class="md-header-nav__topic">
              
                Features
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/zalando-incubator/fabric-gateway/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Fabric Gateway" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Fabric Gateway
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/zalando-incubator/fabric-gateway/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1" checked>
    
    <label class="md-nav__link" for="nav-1">
      Fabric Gateway
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        Fabric Gateway
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../fabric-gateway-getting-started/" title="Getting Started" class="md-nav__link">
      Getting Started
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Features
      </label>
    
    <a href="./" title="Features" class="md-nav__link md-nav__link--active">
      Features
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#gateway-features" title="Gateway Features" class="md-nav__link">
    Gateway Features
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#authentication" title="Authentication" class="md-nav__link">
    Authentication
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#authorization" title="Authorization" class="md-nav__link">
    Authorization
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#admin-access" title="Admin Access" class="md-nav__link">
    Admin Access
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rate-limiting" title="Rate Limiting" class="md-nav__link">
    Rate Limiting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#encryption-in-transit" title="Encryption In Transit" class="md-nav__link">
    Encryption In Transit
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multiple-hosts" title="Multiple Hosts" class="md-nav__link">
    Multiple Hosts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#whitelisting" title="Whitelisting" class="md-nav__link">
    Whitelisting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#employee-whitelisting" title="Employee Whitelisting" class="md-nav__link">
    Employee Whitelisting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cors-support" title="CORS Support" class="md-nav__link">
    CORS Support
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#other" title="Other" class="md-nav__link">
    Other
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#path-matching" title="Path Matching" class="md-nav__link">
    Path Matching
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gateway-generation" title="Gateway Generation" class="md-nav__link">
    Gateway Generation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#gateway-features" title="Gateway Features" class="md-nav__link">
    Gateway Features
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#authentication" title="Authentication" class="md-nav__link">
    Authentication
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#authorization" title="Authorization" class="md-nav__link">
    Authorization
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#admin-access" title="Admin Access" class="md-nav__link">
    Admin Access
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rate-limiting" title="Rate Limiting" class="md-nav__link">
    Rate Limiting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#encryption-in-transit" title="Encryption In Transit" class="md-nav__link">
    Encryption In Transit
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multiple-hosts" title="Multiple Hosts" class="md-nav__link">
    Multiple Hosts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#whitelisting" title="Whitelisting" class="md-nav__link">
    Whitelisting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#employee-whitelisting" title="Employee Whitelisting" class="md-nav__link">
    Employee Whitelisting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cors-support" title="CORS Support" class="md-nav__link">
    CORS Support
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#other" title="Other" class="md-nav__link">
    Other
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#path-matching" title="Path Matching" class="md-nav__link">
    Path Matching
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gateway-generation" title="Gateway Generation" class="md-nav__link">
    Gateway Generation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/zalando-incubator/fabric-gateway/edit/master/docs/fabric-gateway-features.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="fabric-gateway">Fabric Gateway<a class="headerlink" href="#fabric-gateway" title="Permanent link">&para;</a></h1>
<p>Powered by <a href="https://github.com/zalando/skipper">Skipper</a>, Fabric Gateway is a security-audited and scalable solution that makes it easy for developers to secure and monitor APIs at scale.</p>
<p><img alt="Gateway only" src="../img/gateway-only.png" /></p>
<p>The Gateway operates at the Kubernetes Ingress layer and is capable of providing the above features (and more) for all inbound traffic, so application developers don&rsquo;t have to.
A companion <a href="https://zmon.zalando.net/grafana/dashboard/db/fabric">Grafana dashboard</a> allows developers to monitor their Gateway-secured APIs with fine-grained per-client performance visibility.</p>
<p>To enable the Fabric Gateway for an application simply add this Kubernetes <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">Custom Resource Definition</a> (CRD) to its CDP setup (e.g., by placing in <code>deploy/apply</code>). <strong>N.B.</strong> You should not have both a <code>FabricGateway</code> and a standard <code>Ingress</code> resource defined, as the default ingress would not give you any authentication but would allow traffic access to your unprotected backend service. If you are using <code>FabricGateway</code> to manage auth for your service, then please remove any existing ingress resources.</p>
<div class="codehilite"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">zalando.org/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">FabricGateway</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-app-gateway</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">x-fabric-service</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-app.smart-product-platform-test.zalan.do</span>
      <span class="nt">serviceName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-app-service-name</span>
      <span class="nt">servicePort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
  <span class="nt">x-fabric-admins</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">bmooney</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">fmoloney</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">cgallagher</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">jblogs</span>
  <span class="nt">paths</span><span class="p">:</span>
    <span class="nt">/api/resource</span><span class="p">:</span>
      <span class="nt">post</span><span class="p">:</span>
        <span class="nt">x-fabric-privileges</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">&quot;spp-application.write&quot;</span>
        <span class="nt">x-fabric-ratelimits</span><span class="p">:</span>
          <span class="nt">default-rate</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
          <span class="nt">period</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">minute</span>
          <span class="nt">target</span><span class="p">:</span>
            <span class="nt">spp_service_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">50</span>
    <span class="nt">/api/resource/*</span><span class="p">:</span>
      <span class="nt">get</span><span class="p">:</span>
        <span class="nt">x-fabric-privileges</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">&quot;spp-application.read&quot;</span>
      <span class="nt">put</span><span class="p">:</span>
        <span class="nt">x-fabric-privileges</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">&quot;spp-application.write&quot;</span>
        <span class="nt">x-fabric-ratelimits</span><span class="p">:</span>
          <span class="nt">default-rate</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
      <span class="nt">patch</span><span class="p">:</span>
        <span class="nt">x-fabric-privileges</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">&quot;spp-application.write&quot;</span>
        <span class="nt">x-fabric-ratelimits</span><span class="p">:</span>
          <span class="nt">default-rate</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
    <span class="nt">/events</span><span class="p">:</span>
      <span class="nt">post</span><span class="p">:</span>
        <span class="nt">x-fabric-privileges</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">&quot;spp-application.read&quot;</span>
</pre></div>

<p>For <code>servicePort</code>, you <strong>must</strong> specify a <strong>named</strong> port from your service definition. If you don&rsquo;t specify <code>servicePort</code>, Fabric Gateway defaults to a port named &lsquo;http&rsquo;.<br />
Below is an example of a service with a named port:</p>
<div class="codehilite"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">labels</span><span class="p">:</span>
    <span class="nt">application</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">APPLICATION</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="nt">version</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">VERSION</span><span class="nv"> </span><span class="s">}}&quot;</span>
  <span class="nt">name</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">APPLICATION</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">application</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">APPLICATION</span><span class="nv"> </span><span class="s">}}&quot;</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ClusterIP</span>
  <span class="nt">ports</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
      <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
      <span class="nt">targetPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
</pre></div>

<h2 id="gateway-features">Gateway Features<a class="headerlink" href="#gateway-features" title="Permanent link">&para;</a></h2>
<p>Currently the gateway attempts to solve the following re-occurring requirements
for services:</p>
<ul>
<li>Authentication</li>
<li>Authorization</li>
<li>Admin Access</li>
<li>Service Whitelisting</li>
<li>Resource Whitelisting</li>
<li>Encryption In Transit</li>
<li>Rate Limiting</li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">Cross-Origin Resource Sharing</a></li>
</ul>
<p>To create a gateway for your application, you will need to include a gateway resource (sample definition below) in your
<code>deploy/apply</code> folder. If you are using the <a href="/cdp">Fabric CDP gen</a> then this gateway resource will be generated for you.</p>
<h3 id="authentication">Authentication<a class="headerlink" href="#authentication" title="Permanent link">&para;</a></h3>
<p>When using the gateway to authenticate requests to your service, there will be a header added to the request,
<code>X-TokenInfo-Forward</code>. This will contain the <code>uid</code>, <code>scope</code> and <code>realm</code> retrieved from from the <a href="https://cloud.docs.zalando.net/howtos/authenticate-requests/#oauth2-endpoints">Token Info endpoint</a>.</p>
<h3 id="authorization">Authorization<a class="headerlink" href="#authorization" title="Permanent link">&para;</a></h3>
<p>To confirm that each authenticated token is from a valid service or employee, the gateway will implicitly add a scope
check for the <code>uid</code> scope.</p>
<h3 id="admin-access">Admin Access<a class="headerlink" href="#admin-access" title="Permanent link">&para;</a></h3>
<p>Team members can be added to your <code>x-fabric-admins</code> list. The uids in this list will have access to all endpoints and will not be subject to rate-limiting or other authentication rules.</p>
<h3 id="rate-limiting">Rate Limiting<a class="headerlink" href="#rate-limiting" title="Permanent link">&para;</a></h3>
<p>If a client of the gateway is getting rate limited, they will get a <code>429</code>
HTTP response code. There will also be some headers included to indicate
when they will be able to make requests again. Below is a sample rate limited
response from the gateway. The <code>Retry-After</code> header, shows the number of seconds
before you may attempt a new request. The <code>X-Rate-Limit</code> header shows the number
of requests per hour, which the client is allowed to make.</p>
<div class="codehilite"><pre><span></span>curl -i -H <span class="s2">&quot;Authorization: Bearer </span><span class="nv">$FDA</span><span class="s2">&quot;</span> https://fgtestapp.smart-product-platform-test.zalan.do/limited/me

HTTP/2 <span class="m">429</span>
date: Tue, <span class="m">26</span> Mar <span class="m">2019</span> <span class="m">12</span>:05:51 GMT
content-type: text/plain<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
content-length: <span class="m">18</span>
retry-after: <span class="m">53</span>
server: Skipper
x-content-type-options: nosniff
x-rate-limit: <span class="m">120</span>
</pre></div>

<h3 id="encryption-in-transit">Encryption In Transit<a class="headerlink" href="#encryption-in-transit" title="Permanent link">&para;</a></h3>
<p>The gateway will ensure that no requests are hitting your service
unless they are encrypted using <code>https</code>. To achieve this, we have a skipper
filter on every route, which will reject the request with a 400 response if
it contains the <code>X-Forwarded-Proto: http</code> header. This is an extra layer of
security to ensure that people are not interacting with your service in
an insecure manner.</p>
<p>An example request can be seen below:</p>
<div class="codehilite"><pre><span></span>curl -i -H <span class="s2">&quot;Authentication: Bearer </span><span class="k">$(</span>ztoken<span class="k">)</span><span class="s2">&quot;</span> http://fgtestapp.smart-product-platform-test.zalan.do/resources
HTTP/1.1 <span class="m">400</span> Forbidden
Date: Fri, <span class="m">01</span> Mar <span class="m">2019</span> <span class="m">10</span>:38:05 GMT
Content-Type: text/plain<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
Content-Length: <span class="m">104</span>
Connection: keep-alive
Server: Skipper

<span class="o">{</span>
  <span class="s2">&quot;title&quot;</span>: <span class="s2">&quot;Gateway Rejected&quot;</span>,
  <span class="s2">&quot;status&quot;</span>: <span class="m">400</span>,
  <span class="s2">&quot;detail&quot;</span>: <span class="s2">&quot;TLS is required&quot;</span>,
  <span class="s2">&quot;type&quot;</span>: <span class="s2">&quot;https://cloud.docs.zalando.net/howtos/ingress/#redirect-http-to-https&quot;</span>
<span class="o">}</span>
</pre></div>

<h3 id="multiple-hosts">Multiple Hosts<a class="headerlink" href="#multiple-hosts" title="Permanent link">&para;</a></h3>
<p>All created Skipper routes will match incoming requests first by their host.<br />
If you have multiple hosts for a service, then each of these needs to be listed in the gateway resource.</p>
<h3 id="whitelisting">Whitelisting<a class="headerlink" href="#whitelisting" title="Permanent link">&para;</a></h3>
<p>You can define either a global or a route-level whitelist for your gateway as per the below examples.
What this means is that only services whose names are defined in the whitelist will be able
to interact with your service. All other access requirements, i.e. scopes
and rate limits, will still apply to the whitelisted service.</p>
<div class="codehilite"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">zalando.org/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">FabricGateway</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-app-gateway</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">x-fabric-service</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-app.smart-product-platform-test.zalan.do</span>
      <span class="nt">serviceName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-app-service-name</span>
      <span class="nt">servicePort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
  <span class="nt">x-fabric-admins</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">jblogs</span>
  <span class="nt">x-fabric-whitelist</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">stups_some-whitelisted-service</span>
  <span class="nt">paths</span><span class="p">:</span>
    <span class="nt">/api/resource</span><span class="p">:</span>
      <span class="nt">get</span><span class="p">:</span>
        <span class="nt">x-fabric-privileges</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">&quot;spp-application.write&quot;</span>
      <span class="nt">post</span><span class="p">:</span>
        <span class="nt">x-fabric-privileges</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">&quot;spp-application.write&quot;</span>
        <span class="c1"># This is a more fine-grained whitelist and overrides the global whitelist. Only some-other-service can access this path.</span>
        <span class="c1"># This id is taken from the &quot;sub&quot; field of a JWT token. For a service, this value is always &quot;stups_&quot; followed by the application&#39;s Kio id.</span>
        <span class="c1"># some-whitelisted-service from the global whitelist cannot access this path.</span>
        <span class="nt">x-fabric-whitelist</span><span class="p">:</span>
          <span class="nt">service-list</span><span class="p">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">stups_some-other-service</span>
      <span class="nt">head</span><span class="p">:</span>
        <span class="nt">x-fabric-privileges</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">&quot;spp-application.read&quot;</span>
        <span class="c1"># Another type of fine-grained whitelist over-ride is to disabled whitelisting altogether and allow any</span>
        <span class="c1"># service which has the correct scopes to access the route.</span>
        <span class="nt">x-fabric-whitelist</span><span class="p">:</span>
          <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">disabled</span>
          <span class="nt">service-list</span><span class="p">:</span> <span class="p p-Indicator">[]</span>
    <span class="l l-Scalar l-Scalar-Plain">/api/resource/{resource_id}</span><span class="p p-Indicator">:</span>
      <span class="nt">put</span><span class="p">:</span>
        <span class="c1"># This whitelist config overrides the global whitelist and because of the empty whitelist</span>
        <span class="c1"># no other service will be able to access this route. i.e. Only defined admins would be able to access the</span>
        <span class="c1"># route</span>
        <span class="nt">x-fabric-whitelist</span><span class="p">:</span>
          <span class="nt">service-list</span><span class="p">:</span> <span class="p p-Indicator">[]</span>
</pre></div>

<h3 id="employee-whitelisting">Employee Whitelisting<a class="headerlink" href="#employee-whitelisting" title="Permanent link">&para;</a></h3>
<p>Employee tokens do not use scopes, so in order to allow certain employees access to an endpoint we must whitelist their uid. Note that this is different to <a href="#admin-access">Admin Access</a> since admins are not subject to rate limits.<br />
In the example below, we can see that the <code>/api/resource</code> <code>get</code> endpoint can be accessed by services with the <code>spp-application.write</code> scope or the employee whose uid is <code>useruid</code>. The service and the employee will be subject to a ratelimit of 5 requests per minute.</p>
<div class="codehilite"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">zalando.org/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">FabricGateway</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-app-gateway</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">x-fabric-service</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-app.smart-product-platform-test.zalan.do</span>
      <span class="nt">serviceName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-app-service-name</span>
      <span class="nt">servicePort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
  <span class="nt">paths</span><span class="p">:</span>
    <span class="nt">/api/resource</span><span class="p">:</span>
      <span class="nt">get</span><span class="p">:</span>
        <span class="nt">x-fabric-privileges</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">&quot;spp-application.write&quot;</span>
        <span class="nt">x-fabric-employee-access</span><span class="p">:</span>
          <span class="nt">user-list</span><span class="p">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">useruid</span>
        <span class="nt">x-fabric-ratelimits</span><span class="p">:</span>
          <span class="nt">default-rate</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
</pre></div>

<h3 id="cors-support">CORS Support<a class="headerlink" href="#cors-support" title="Permanent link">&para;</a></h3>
<p>For browser applications to communicate directly with an API, the API needs to support <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">Cross-Origin Resource Sharing</a>. The Gateway supports this by automatically adding an OPTIONS endpoint to each of your paths to handle browser <a href="https://developer.mozilla.org/en-US/docs/Glossary/Preflight_request">Preflight Requests</a>. The origins and headers you configure will be allowed in the response headers. Additionally, configuring cors support causes the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Origin">Access-Control-Allow-Origin header</a> to contain the request&rsquo;s <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Origin">Origin</a> if you have whitelisted it here.  </p>
<p>Note: We do not allow <code>*</code> to be used as an allowed origin. Every Gateway API will want to allow the <code>Authorization</code> and <code>Content-Type</code> headers here, to allow auth tokens and the <code>application/json</code> <code>Content-Type</code> to be used.</p>
<p>In the example below, they gateway will generate an OPTIONS route for the <code>/api/resources</code> path. This will support preflighted requests for your listed HTTP verbs, <code>allowedOrigins</code> and <code>allowedHeaders</code>. Once the preflight is done, the actual request will also automatically have the right <code>Access-Control-Allow-Origin</code> header if the request Origin is allowed.</p>
<div class="codehilite"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">zalando.org/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">FabricGateway</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-app-gateway</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">x-fabric-service</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-app.smart-product-platform-test.zalan.do</span>
      <span class="nt">serviceName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-app-service-name</span>
      <span class="nt">servicePort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
  <span class="nt">x-fabric-cors-support</span><span class="p">:</span>
    <span class="nt">allowedOrigins</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">example.com</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">example-other.com</span>
    <span class="nt">allowedHeaders</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Authorization</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Content-Type</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">X-Flow-Id</span>
  <span class="nt">paths</span><span class="p">:</span>
    <span class="nt">/api/resource</span><span class="p">:</span>
      <span class="nt">get</span><span class="p">:</span>
        <span class="nt">x-fabric-privileges</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">&quot;spp-application.write&quot;</span>
</pre></div>

<h2 id="other">Other<a class="headerlink" href="#other" title="Permanent link">&para;</a></h2>
<h3 id="path-matching">Path Matching<a class="headerlink" href="#path-matching" title="Permanent link">&para;</a></h3>
<p>There are some rules around path matching in the gateway which are outlined below.</p>
<ul>
<li>Dynamic path segments should be represented by either a <code>*</code> or a <code>{named}</code> parameter</li>
<li>Wildcard matching of multiple path segments can be performed by using <code>**</code>, the <code>**</code> must be the last part of the path</li>
</ul>
<p>Examples of some valid and invalid paths are outlined below:</p>
<div class="codehilite"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">zalando.org/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">FabricGateway</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-app-gateway</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">x-fabric-service</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">host</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-app.smart-product-platform-test.zalan.do</span>
      <span class="nt">serviceName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-app-service-name</span>
      <span class="nt">servicePort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
  <span class="nt">x-fabric-admins</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">jblogs</span>
  <span class="nt">paths</span><span class="p">:</span>
    <span class="c1"># This is an exact path match. The only URI that will be matched is a GET request against `/api/resource`</span>
    <span class="nt">/api/resource</span><span class="p">:</span>
      <span class="nt">get</span><span class="p">:</span>
        <span class="nt">x-fabric-privileges</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">&quot;spp-application.read&quot;</span>
    <span class="c1"># Match a path which has a dynamic segment. This will match any identifer for the resource</span>
    <span class="c1"># e.g. /api/resource/123 /api/resource/abc-123 etc...</span>
    <span class="c1"># However this will only match a single path segment so the below would not be matched</span>
    <span class="c1"># /api/resource/123/sub-resource</span>
    <span class="nt">/api/resource/*</span><span class="p">:</span>
          <span class="nt">get</span><span class="p">:</span>
            <span class="nt">x-fabric-privileges</span><span class="p">:</span>
              <span class="p p-Indicator">-</span> <span class="s">&quot;spp-application.read&quot;</span>
    <span class="c1"># This is the exact same as the above dynamic segment matching, except that the segment is named.</span>
    <span class="c1"># The name of the segment currently has no extra significance</span>
    <span class="l l-Scalar l-Scalar-Plain">/api/resource/{resource_id}</span><span class="p p-Indicator">:</span>
          <span class="nt">get</span><span class="p">:</span>
            <span class="nt">x-fabric-privileges</span><span class="p">:</span>
              <span class="p p-Indicator">-</span> <span class="s">&quot;spp-application.read&quot;</span>
    <span class="c1"># The double * is a wildcard match. This wildcard will match across multiple segments in the URI</span>
    <span class="c1"># For example the following paths would be successfully matched:</span>
    <span class="c1"># e.g. /api/someresource/123 /api/someresource/123/sub-resource /api/someresource/123/sub-resource/123</span>
    <span class="nt">/api/someresource/**</span><span class="p">:</span>
      <span class="nt">get</span><span class="p">:</span>
        <span class="nt">x-fabric-privileges</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">&quot;spp-application.read&quot;</span>
    <span class="c1"># There is a requirement for ** to be at the end of the path. The below path key would be considered</span>
    <span class="c1"># invalid</span>
    <span class="nt">/api/someresource/**/subkey</span><span class="p">:</span>
      <span class="nt">get</span><span class="p">:</span>
        <span class="nt">x-fabric-privileges</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">&quot;spp-application.read&quot;</span>  
</pre></div>

<h3 id="gateway-generation">Gateway Generation<a class="headerlink" href="#gateway-generation" title="Permanent link">&para;</a></h3>
<p>A fabric gateway definition can be generated by sending your <a href="https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.2.md">Open API Specification</a>
aka OAS to the fabric resource generator. This service queries the <a href="https://apis.zalando.net/apis/teams-api/ui">Teams Api</a>
and returns a gateway based on your OAS which is enriched with an admins list containing all the members on your team.</p>
<p>Example of the curl request needed to use this service:</p>
<div class="codehilite"><pre><span></span>curl -i --data-binary @yourOAS.yaml -H <span class="s1">&#39;Content-Type: application/x-yaml&#39;</span> -H  <span class="s2">&quot;Authorization: Bearer </span><span class="k">$(</span>ztoken<span class="k">)</span><span class="s2">&quot;</span>
-X POST https://fabric-resource-generator.smart-product-platform.zalan.do/api/gateways
</pre></div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../fabric-gateway-getting-started/" title="Getting Started" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Getting Started
              </span>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.245445c6.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
        <script src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js"></script>
      
    
  </body>
</html>